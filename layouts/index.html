{{ define "main" }}
  <div id="post-list">
    {{ range .Paginator.Pages }}
      {{ .Render "summary" }}
    {{ end }}
  </div>

  <div id="pagination">
    {{ if .Paginator.HasNext }}
      <a href="{{ .Paginator.Next.URL }}" id="next-page">Next</a>
    {{ end }}
  </div>

  {{ partial "search.html" . }}

  <script>
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const nextPageLink = document.getElementById("next-page");
          if (!nextPageLink) return;

          fetch(nextPageLink.href)
            .then(response => response.text())
            .then(html => {
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, "text/html");
              const newPosts = doc.querySelectorAll("#post-list > *");
              const nextLink = doc.querySelector("#next-page");

              newPosts.forEach(post => {
                document.querySelector("#post-list").appendChild(post);
              });

              if (nextLink) {
                nextPageLink.href = nextLink.href;
              } else {
                nextPageLink.remove();
              }
            });

          observer.unobserve(entry.target);
        }
      });
    }, {
      rootMargin: "100px",
    });

    const nextPage = document.getElementById("next-page");
    if (nextPage) {
      observer.observe(nextPage);
    }
  </script>
{{ end }}
